<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
		<title>Blockdoku</title>
		<meta name="description" content="Block Sudoku Puzzle Game" />
		<link rel="stylesheet" href="/styles.css" />
		<link rel="manifest" href="/manifest.json" />
		<meta name="theme-color" content="#1a1a1a" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	</head>
	<body>
		<div id="app">
			<header>
				<button id="settings-btn" aria-label="Settings">‚öôÔ∏è</button>
				<div class="score-board">
					<div class="score-label">BEST <span id="best-score">0</span></div>
					<div id="status-face" class="face-normal"></div>
					<div class="score-label">SCORE <span id="current-score">0</span></div>
				</div>
				<div class="header-right-buttons">
					<button id="leaderboard-header-btn" aria-label="View Leaderboard">üèÜ</button>
					<button id="pause-btn" aria-label="Pause Game">‚è∏</button>
				</div>
			</header>

			<div id="tutorial-overlay" class="hidden overlay pointer-events-none">
				<div class="tutorial-box pointer-events-auto">
					<h2 id="tutorial-title">How to Play</h2>
					<p id="tutorial-text"></p>
					<!-- Action Buttons Container -->
					<div class="tutorial-actions">
						<button id="tutorial-next-btn" class="primary-btn">Next</button>
						<button id="tutorial-skip-btn" class="secondary-btn">Skip</button>
					</div>
				</div>
			</div>

			<div id="replay-overlay" class="hidden overlay">
				<div class="replay-controls">
					<div class="replay-header">
						<h2>Replaying Game</h2>
						<div class="replay-stats">
							<span>Move: <span id="replay-move">0</span>/<span id="replay-total">0</span></span>
							<span>Score: <span id="replay-score">0</span></span>
						</div>
					</div>
					<button id="replay-exit" class="secondary-btn">Exit</button>
				</div>
			</div>

			<div id="highscore-notification" class="hidden">New High Score!</div>

			<main id="game-container">
				<canvas id="game-canvas"></canvas>
				<div id="hand-timer-bottom" class="hand-timer-bar">
					<div class="hand-timer-fill"></div>
				</div>
				<div id="game-over-overlay" class="hidden overlay">
					<h1>Game Over</h1>
					<p id="game-over-highscore-label" class="hidden">New High Score!</p>
					<p>Final Score: <span id="final-score">0</span></p>
					<p id="game-over-quote"></p>
					<div class="name-input-group">
						<input type="text" id="player-name-input" maxlength="20" placeholder="Player" />
						<button id="submit-score-btn" class="secondary-btn">Submit Score</button>
					</div>
					<div id="submission-status-message" class="hidden"></div>
					<div id="leaderboard-ranking" class="hidden"></div>
					<div class="game-over-actions">
						<div id="post-submission-actions">
							<button id="restart-btn" class="primary-btn">Try Again</button>
							<button id="replay-btn" class="secondary-btn">‚ñ∂ Watch Replay</button>
						</div>
					</div>
				</div>
				<div id="pause-overlay" class="hidden overlay">
					<h1>Paused</h1>
					<p id="pause-instruction">Tap anywhere to resume</p>
				</div>
				<div id="settings-modal" class="hidden overlay">
					<div class="modal-content">
						<h2>Settings</h2>
						<div class="setting-item">
							<label for="sensitivity-slider">Sensitivity: <span id="sensitivity-value">1.0</span></label>
							<input type="range" id="sensitivity-slider" min="1.0" max="3.0" step="0.1" value="1.0" />
						</div>
						<div class="setting-item" style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px">
							<button id="clear-cache-btn" class="secondary-btn" style="width: 100%; border: 1px solid #ff4444; color: #ff4444">Clear Cache & Reload</button>
						</div>
						<button id="close-settings-btn">Close</button>
					</div>
				</div>

				<div id="leaderboard-modal" class="hidden overlay">
					<div class="leaderboard-content">
						<div class="leaderboard-header">
							<h2>Leaderboard</h2>
							<button id="leaderboard-close-btn" class="secondary-btn small">Close</button>
						</div>
						<div id="leaderboard-error" class="leaderboard-message hidden"></div>
						<div id="leaderboard-loading" class="leaderboard-message hidden">Loading...</div>
						<div class="leaderboard-sections">
							<section class="leaderboard-section">
								<h3>Top Verified Scores</h3>
								<ol id="leaderboard-verified-list" class="leaderboard-list"></ol>
							</section>
						</div>
					</div>
				</div>
			</main>

			<footer>
				<span id="app-version"></span>
			</footer>
		</div>
		<script type="module" src="/src/main.ts"></script>
		<script>
			// Player Name Persistence
			const nameInput = document.getElementById("player-name-input")
			if (nameInput) {
				// Load name on page load
				const savedName = localStorage.getItem("bp_player_name")
				if (savedName) nameInput.value = savedName

				// Save name when input loses focus (blur). The 'input' event was too aggressive.
				nameInput.addEventListener("blur", (e) => {
					const value = e.target.value.trim()
					if (value) {
						localStorage.setItem("bp_player_name", value)
					} else {
						localStorage.removeItem("bp_player_name")
					}
				})
			}

			if ("serviceWorker" in navigator) {
				window.addEventListener("load", () => {
					const isLocalhost = Boolean(
						window.location.hostname === "localhost" ||
							// [::1] is the IPv6 localhost address.
							window.location.hostname === "[::1]" ||
							// 127.0.0.1/8 is considered localhost for IPv4.
							window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)
					)

					if (isLocalhost) {
						console.log("ServiceWorker is disabled on localhost")
						navigator.serviceWorker.getRegistrations().then(function (registrations) {
							for (let registration of registrations) {
								registration.unregister()
							}
						})
					} else {
						// Register the Service Worker for production
						// We add a timestamp to the URL to ensure the SW file itself is never cached
						navigator.serviceWorker
							.register("/service-worker.js?v=" + Date.now())
							.then((registration) => {
								console.log("ServiceWorker registered: ", registration)
							})
							.catch((registrationError) => {
								console.log("ServiceWorker registration failed: ", registrationError)
							})
					}
				})
			}
		</script>
	</body>
</html>
